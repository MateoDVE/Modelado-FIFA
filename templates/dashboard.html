<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ Sistema Integrado de An√°lisis de Futbolistas | ML + EDO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .slider-container {
            margin-bottom: 15px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        #result-section {
            display: none;
        }
        .prediction-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .growth-value {
            font-size: 1.2rem;
            color: #198754;
        }
        .growth-negative {
            color: #dc3545;
        }
        .metric-card {
            border-left: 4px solid #0d6efd;
            padding: 15px;
            background: white;
 <!-- Navbar -->
<nav class="navbar navbar-dark navbar-custom mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">
            <i class="fas fa-futbol"></i> Sistema Integrado de An√°lisis de Futbolistas
        </span>
        <span class="navbar-text text-white">
            <small><i class="fas fa-brain"></i> ML + <i class="fas fa-chart-line"></i> EDO (D√≠a 2 + D√≠a 3)</small>
        </span>
    </div>
</nav>

<div class="container">
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle"></i> <strong>Sistema Completo:</strong> 
        Predicci√≥n de Potential y Posici√≥n con Redes Neuronales (D√≠a 2) + 
        Simulaci√≥n Din√°mica de Carrera con Ecuaciones Diferenciales (D√≠a 3)
    </div
        }
        .metric-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #212529;
        }
        .badge-custom {
            font-size: 0.9rem;
            padding: 0.5em 1em;
        }
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .recommendation-item {
            padding: 10px;
            border-left: 3px solid #28a745;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-4">Simulador de Futbolistas con IA</h1>
    
    <div class="row">
        <!-- Input Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Par√°metros del Jugador
                </div>
                <div class="card-body">
                    <form id="prediction-form">
                        <div class="mb-3">
                            <label class="form-label"><strong>R√©gimen de Entrenamiento:</strong></label>
                            <select class="form-select" id="training-regime">
                                <option value="balanced" selected>‚öñÔ∏è Balanceado (0.7, 0.7, 0.7)</option>
                                <option value="intensive">üî• Intensivo (0.9, 0.9, 0.8)</option>
                                <option value="technical">‚öΩ T√©cnico (0.5, 0.9, 0.7)</option>
                                <option value="physical">üí™ F√≠sico (0.9, 0.6, 0.6)</option>
                                <option value="conservative">üõ°Ô∏è Conservador (0.5, 0.5, 0.5)</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-rocket"></i> Ejecutar An√°lisis Completo
                            </button>
                        </div>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> Procesamiento: ~0.5s
                            </small
                                <label for="fisico">F√≠sico</label>
                                <span id="val-fisico">50</span>
                            </div>
                            <input type="range" class="form-range" id="fisico" min="0" max="100" value="50">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="tecnica">Talento (T√©cnica)</label>
                                <span id="val-tecnica">50</span>
                            </div>
                            <input type="range" class="form-range" id="tecnica" min="0" max="100" value="50">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="mentalidad">Mentalidad</label>
                                <span id="val-mentalidad">50</span>
                            </div>
                            <input type="range" class="form-range" id="mentalidad" min="0" max="100" value="50">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="rating">Rating Actual</label>
                                <span id="val-rating">50</span>
                            </div>
                            <input type="range" class="form-range" id="rating" min="0" max="100" value="50">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="edad">Edad</label>
                                <span id="val-edad">25</span>
                            </div>
                            <input type="range" class="form-range" id="edad" min="15" max="45" value="25">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="lesiones" class="text-danger">Riesgo Lesiones</label>
                                <span id="val-lesiones">0</span>
                            </div>
                            <input type="range" class="form-range" id="lesiones" min="0" max="100" value="0">
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">Simular Predicci√≥n</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="col-md-8">
            <div id="result-section">
                <div class="row">
                    <!-- Potential Prediction -->
                    <div class="col-md-6">
                        <div class="card text-center h-100">
                            <div class="card-header bg-info text-white">
                                Potencial Estimado (Red 1)
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center">
                                <div class="prediction-value" id="pred-potential">--</div>
                                <div class="growth-value" id="pred-growth">Crecimiento: --</div>
                                <p class="mt-3 text-muted">Basado en atributos f√≠sicos, t√©cnicos y mentales.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Position Prediction -->
                    <div class="col-md-6">
                        <div class="card text-center h-100">
                            <div class="card-header bg-warning text-dark">
                                Posici√≥n Ideal (Red 2)
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center">
                                <div class="prediction-value" id="pred-position">--</div>
                                <p class="mt-3 text-muted">Posici√≥n recomendada seg√∫n perfil.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Probabilities Chart -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar"></i> Probabilidades por Posici√≥n (Red Neuronal 2)
                            </div>
                            <div class="card-body">
                                <canvas id="probsChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics Summary -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-title"><i class="fas fa-star"></i> Rating Pico</div>
                            <div class="metric-value" id="metric-peak">--</div>
                            <small class="text-muted" id="metric-peak-age">@ -- a√±os</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-title"><i class="fas fa-chart-line"></i> Desarrollo</div>
                            <div class="metric-value" id="metric-development">--</div>
                            <small class="text-muted">puntos de crecimiento</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-title"><i class="fas fa-trophy"></i> ¬øAlcanza Potencial?</div>
                            <div class="metric-value" id="metric-potential-reached">--</div>
                            <small class="text-muted" id="metric-potential-pct">--</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-title"><i class="fas fa-hourglass-half"></i> Carrera √ötil</div>
                            <div class="metric-value" id="metric-career">-- a√±os</div>
                            <small class="text-muted">hasta rating < 70</small>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-lightbulb"></i> Recomendaciones del Sistema
                            </div>
                            <div class="card-body" id="recommendations-container">
                                <p class="text-muted">Las recomendaciones aparecer√°n despu√©s del an√°lisis...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Simulation Chart -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-chart-area"></i> Evoluci√≥n del Rendimiento (10 a√±os)
                            </div>
                            <div class="card-body">
                                <canvas id="simChart" height="150"></canvas>
                                <p class="text-muted small mt-2">
                                    * <strong>R (Rojo):</strong> Overall Rating | <strong>F (Verde):</strong> F√≠sico | 
                                    <strong>T (Azul):</strong> T√©cnica | <strong>M (Amarillo):</strong> Mentalidad
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fatigue Chart -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-tired"></i> Fatiga Acumulada
                            </div>
                            <div class="card-body">
                                <canvas id="fatigueChart" height="80"></canvas>
                                <p class="text-muted small mt-2">
                                    La fatiga afecta el desarrollo. Niveles altos (>0.7) reducen efectividad del entrenamiento.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Statistics Table -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-table"></i> Estad√≠sticas Detalladas por Atributo
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="stats-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Atributo</th>
                                                <th>Inicial</th>
                                                <th>Final</th>
                                                <th>M√°ximo</th>
                                                <th>M√≠nimo</th>
                                                <th>Promedio</th>
                                                <th>Cambio</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stats-tbody">
                                            <tr><td colspan="7" class="text-center text-muted">Ejecuta el an√°lisis para ver estad√≠sticas...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Growth Rate Analysis -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-tachometer-alt"></i> An√°lisis de Tasas de Cambio
                            </div>
                            <div class="card-body">
                                <canvas id="derivativesChart" height="100"></canvas>
                                <p class="text-muted small mt-2">
                                    Muestra la velocidad de cambio de cada atributo. Valores positivos = crecimiento, negativos = declive.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Placeholder when no results -->
            <div id="placeholder-section" class="text-center p-5">
                <div class="card">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-5x text-muted mb-4"></i>
                        <h3><i class="fas fa-hand-point-left"></i> Configura los Par√°metros</h3>
                        <p class="text-muted">Ajusta edad, atributos y r√©gimen de entrenamiento, luego presiona <strong>"Ejecutar An√°lisis Completo"</strong></p>
                        
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                                    <h6>Red Neuronal 1</h6>
                                    <small class="text-muted">Predicci√≥n de Potential (Regresi√≥n)</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-sitemap fa-2x text-warning mb-2"></i>
                                    <h6>Red Neuronal 2</h6>
                                    <small class="text-muted">Clasificaci√≥n de Posici√≥n</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <i class="fas fa-project-diagram fa-2x text-success mb-2"></i>
                                    <h6>Simulaci√≥n EDO</h6>
                                    <small class="text-muted">Trayectoria de Carrera (RK4)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="mt-5 py-4 bg-dark text-white">
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <h5><i class="fas fa-futbol"></i> Sistema Integrado de An√°lisis</h5>
                <p class="small">
                    Combina Machine Learning (D√≠a 2) con Ecuaciones Diferenciales Ordinarias (D√≠a 3) 
                    para an√°lisis predictivo completo de carreras deportivas.
                </p>
            </div>
            <div class="col-md-3">
                <h6>Tecnolog√≠as</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check"></i> Redes Neuronales (MLP)</li>
                    <li><i class="fas fa-check"></i> M√©todo RK4</li>
                    <li><i class="fas fa-check"></i> Flask + Bootstrap</li>
                    <li><i class="fas fa-check"></i> Chart.js</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6>Componentes</h6>
                <ul class="list-unstyled small">
                    <li>üìä Red 1: Regresi√≥n (Potential)</li>
                    <li>üéØ Red 2: Clasificaci√≥n (Posici√≥n)</li>
                    <li>üìà EDO: Simulaci√≥n Din√°mica</li>
                    <li>üí° Recomendaciones IA</li>
                </ul>
            </div>
        </div>
        <hr class="bg-light">
        <div class="text-center small">
            <p class="mb-0">
                <i class="fas fa-code"></i> Pr√°ctica Integrada Avanzada - Diciembre 2025 | 
                <i class="fas fa-flask"></i> Proyecto Acad√©mico
            </p>
        </div>
    </div>
</footer>

<script>
    // Global chart instances
    let probsChart = null;
    let simChart = null;
    let fatigueChart = null;
    let derivativesChart = null;

    // Update slider values
    const inputs = ['fisico', 'tecnica', 'mentalidad', 'rating', 'edad', 'lesiones'];
    inputs.forEach(id => {
        const slider = document.getElementById(id);
        const label = document.getElementById(`val-${id}`);
        slider.addEventListener('input', () => {
            label.textContent = slider.value;
        });
    });

    // myChart for position probabilities (separate from others)
    let myChart = null;

    // Calculate numerical derivatives
    function calculateDerivatives(sim) {
        const dt = 1/52; // weekly timestep
        const dF = [], dT = [], dM = [], dR = [];
        
        for (let i = 1; i < sim.F.length; i++) {
            dF.push((sim.F[i] - sim.F[i-1]) / dt);
            dT.push((sim.T[i] - sim.T[i-1]) / dt);
            dM.push((sim.M[i] - sim.M[i-1]) / dt);
            dR.push((sim.R[i] - sim.R[i-1]) / dt);
        }
        return { dF, dT, dM, dR };
    }

    // Build statistics table
    function buildStatisticsTable(sim) {
        const stats = [
            { name: 'F√≠sico (F)', data: sim.F, color: '#28a745' },
            { name: 'T√©cnica (T)', data: sim.T, color: '#007bff' },
            { name: 'Mental (M)', data: sim.M, color: '#ffc107' },
            { name: 'Rating (R)', data: sim.R, color: '#dc3545' }
        ];
        
        const tbody = document.getElementById('stats-tbody');
        tbody.innerHTML = '';
        
        stats.forEach(stat => {
            const initial = stat.data[0];
            const final = stat.data[stat.data.length - 1];
            const max = Math.max(...stat.data);
            const min = Math.min(...stat.data);
            const avg = stat.data.reduce((a, b) => a + b, 0) / stat.data.length;
            const change = final - initial;
            const changeClass = change >= 0 ? 'text-success' : 'text-danger';
            const changeIcon = change >= 0 ? '‚ñ≤' : '‚ñº';
            
            tbody.innerHTML += `
                <tr>
                    <td><strong style="color: ${stat.color}">${stat.name}</strong></td>
                    <td>${initial.toFixed(2)}</td>
                    <td>${final.toFixed(2)}</td>
                    <td>${max.toFixed(2)}</td>
                    <td>${min.toFixed(2)}</td>
                    <td>${avg.toFixed(2)}</td>
                    <td class="${changeClass}"><strong>${changeIcon} ${change >= 0 ? '+' : ''}${change.toFixed(2)}</strong></td>
                </tr>
            `;
        });
    }

    // Generate recommendations based on simulation
    function generateRecommendations(simData, peakAge, peakR, development, reachedPotential, inputData) {
        const recommendations = [];
        const age = parseFloat(inputData.Edad);
        const fisico = parseFloat(inputData.Fisico);
        const tecnica = parseFloat(inputData.Tecnica);
        const lesiones = parseFloat(inputData.Lesiones);
        
        // Age-based recommendations
        if (age < 22) {
            recommendations.push({
                icon: 'fa-seedling',
                color: 'success',
                text: `<strong>Joven Promesa:</strong> A los ${age} a√±os, est√° en fase √≥ptima de desarrollo. Maximizar entrenamiento intensivo hasta los 24-25 a√±os.`
            });
        } else if (age >= 22 && age < 28) {
            recommendations.push({
                icon: 'fa-fire',
                color: 'warning',
                text: `<strong>Prime Time:</strong> Ventana cr√≠tica de rendimiento. Pico esperado a los ${peakAge.toFixed(1)} a√±os con rating ${peakR.toFixed(1)}.`
            });
        } else if (age >= 28 && age < 32) {
            recommendations.push({
                icon: 'fa-trophy',
                color: 'info',
                text: `<strong>Madurez:</strong> En o cerca del pico. Ajustar intensidad para prevenir lesiones y extender carrera.`
            });
        } else {
            recommendations.push({
                icon: 'fa-heart',
                color: 'danger',
                text: `<strong>Veterano:</strong> Enfoque en mantenimiento. Reducir carga f√≠sica, compensar con experiencia mental.`
            });
        }
        
        // Technical recommendations
        if (tecnica < 70) {
            recommendations.push({
                icon: 'fa-futbol',
                color: 'primary',
                text: `<strong>T√©cnica Mejorable:</strong> Rating t√©cnico ${tecnica.toFixed(0)}. Incrementar entrenamiento t√©cnico (ET) a 0.8+ para mejores resultados.`
            });
        } else if (tecnica > 85) {
            recommendations.push({
                icon: 'fa-star',
                color: 'success',
                text: `<strong>Excelencia T√©cnica:</strong> Alto nivel t√©cnico (${tecnica.toFixed(0)}). Esto permitir√° envejecer mejor y mantener rendimiento post-30.`
            });
        }
        
        // Physical recommendations
        if (fisico > 85 && age > 26) {
            recommendations.push({
                icon: 'fa-running',
                color: 'warning',
                text: `<strong>Alerta F√≠sica:</strong> Alto desgaste f√≠sico previsto. Reducir intensidad f√≠sica tras los ${Math.max(28, age + 2)} a√±os.`
            });
        }
        
        // Injury recommendations
        if (lesiones > 50) {
            recommendations.push({
                icon: 'fa-ambulance',
                color: 'danger',
                text: `<strong>Alto Riesgo de Lesiones:</strong> Implementar r√©gimen conservador (0.5-0.6) y programa preventivo. Impacto estimado: -${(lesiones * 0.02).toFixed(1)} puntos.`
            });
        } else if (lesiones > 0) {
            recommendations.push({
                icon: 'fa-medkit',
                color: 'warning',
                text: `<strong>Riesgo Moderado:</strong> Monitorear cargas de entrenamiento. Balance entre intensidad y recuperaci√≥n.`
            });
        }
        
        // Potential recommendations
        if (!reachedPotential && development > 0) {
            const gap = (inputData.potential || 85) - peakR;
            recommendations.push({
                icon: 'fa-chart-line',
                color: 'info',
                text: `<strong>Potencial no Alcanzado:</strong> Brecha de ${gap.toFixed(1)} puntos. Considerar aumentar intensidad de entrenamiento o ajustar r√©gimen.`
            });
        } else if (reachedPotential) {
            recommendations.push({
                icon: 'fa-check-circle',
                color: 'success',
                text: `<strong>¬°Potencial Alcanzado!</strong> El sistema predice que alcanzar√° ~${(peakR * 100 / (inputData.potential || 85)).toFixed(0)}% de su potencial m√°ximo.`
            });
        }
        
        // Career planning
        if (peakAge - age > 2) {
            recommendations.push({
                icon: 'fa-calendar-alt',
                color: 'primary',
                text: `<strong>Planificaci√≥n:</strong> Faltan ${(peakAge - age).toFixed(1)} a√±os para el pico. Ventana √≥ptima de transferencia: ${(peakAge - 1).toFixed(0)}-${(peakAge + 2).toFixed(0)} a√±os.`
            });
        } else if (Math.abs(peakAge - age) <= 2) {
            recommendations.push({
                icon: 'fa-gem',
                color: 'warning',
                text: `<strong>Momento √ìptimo:</strong> En ventana de m√°ximo valor. Ideal para fichajes importantes o renovaci√≥n de contrato.`
            });
        }
        
        // Development recommendations
        if (development > 10) {
            recommendations.push({
                icon: 'fa-rocket',
                color: 'success',
                text: `<strong>Alto Potencial de Crecimiento:</strong> Proyecci√≥n de +${development.toFixed(1)} puntos. Inversi√≥n recomendada en desarrollo a largo plazo.`
            });
        } else if (development < 0) {
            recommendations.push({
                icon: 'fa-arrow-down',
                color: 'danger',
                text: `<strong>Declive Previsto:</strong> ${development.toFixed(1)} puntos. Enfoque en mantenimiento y rol rotativo.`
            });
        }
        
        // Render recommendations
        const container = document.getElementById('recommendations-container');
        container.innerHTML = recommendations.map(rec => `
            <div class="recommendation-item">
                <i class="fas ${rec.icon} text-${rec.color}"></i>
                ${rec.text}
            </div>
        `).join('');
    }

    // Chart instances
    document.getElementById('prediction-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            Fisico: document.getElementById('fisico').value,
            Tecnica: document.getElementById('tecnica').value,
            Mentalidad: document.getElementById('mentalidad').value,
            Ratting: document.getElementById('rating').value,
            Edad: document.getElementById('edad').value,
            Lesiones: document.getElementById('lesiones').value
        };

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            // Show results
            document.getElementById('result-section').style.display = 'block';
            document.getElementById('placeholder-section').style.display = 'none';
            
            // Update Potential
            if (result.potential) {
                document.getElementById('pred-potential').textContent = result.potential.toFixed(1);
                const growth = result.growth;
                const growthEl = document.getElementById('pred-growth');
                growthEl.textContent = `Crecimiento: ${growth >= 0 ? '+' : ''}${growth.toFixed(1)}`;
                growthEl.className = growth >= 0 ? 'growth-value' : 'growth-value growth-negative';
            }
            
            // Update Position
            if (result.position) {
                document.getElementById('pred-position').textContent = result.position;
            }
            
            // Update Probs Chart
            if (result.position_probs) {
                const ctx = document.getElementById('probsChart').getContext('2d');
                const labels = Object.keys(result.position_probs);
                const values = Object.values(result.position_probs).map(v => v * 100); // percentage
                
                if (myChart) {
                    myChart.destroy();
                }
                
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Probabilidad (%)',
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            // Update Simulation Chart
            if (result.simulation) {
                const ctxSim = document.getElementById('simChart').getContext('2d');
                const simData = result.simulation;
                
                // Calculate metrics from simulation
                const peakR = Math.max(...simData.R);
                const peakIdx = simData.R.indexOf(peakR);
                const peakAge = simData.age[peakIdx];
                const initialR = simData.R[0];
                const development = peakR - initialR;
                const potential = result.potential || 85;
                const reachedPotential = peakR >= (potential * 0.95);
                const potentialPct = ((peakR / potential) * 100).toFixed(1);
                
                // Career length (until R < 70)
                let careerYears = 0;
                for (let i = 0; i < simData.R.length; i++) {
                    if (simData.R[i] < 70) {
                        careerYears = simData.age[i] - simData.age[0];
                        break;
                    }
                }
                if (careerYears === 0) careerYears = simData.age[simData.age.length - 1] - simData.age[0];
                
                // Update metrics
                document.getElementById('metric-peak').textContent = peakR.toFixed(1);
                document.getElementById('metric-peak-age').textContent = `@ ${peakAge.toFixed(1)} a√±os`;
                document.getElementById('metric-development').textContent = development >= 0 ? `+${development.toFixed(1)}` : development.toFixed(1);
                document.getElementById('metric-development').style.color = development >= 0 ? '#28a745' : '#dc3545';
                document.getElementById('metric-potential-reached').textContent = reachedPotential ? '‚úì S√≠' : '‚úó No';
                document.getElementById('metric-potential-reached').style.color = reachedPotential ? '#28a745' : '#ffc107';
                document.getElementById('metric-potential-pct').textContent = `${potentialPct}% del potencial`;
                document.getElementById('metric-career').textContent = careerYears.toFixed(1);
                
                // Pass potential to recommendations
                data.potential = potential;
                generateRecommendations(simData, peakAge, peakR, development, reachedPotential, data);
                
                if (simChart) simChart.destroy();
                
                simChart = new Chart(ctxSim, {
                    type: 'line',
                    data: {
                        labels: simData.age, // X-axis: Age
                        datasets: [
                            {
                                label: 'Rating General (R)',
                                data: simData.R,
                                borderColor: 'rgba(220, 53, 69, 1)', // Red
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'F√≠sico (F)',
                                data: simData.F,
                                borderColor: 'rgba(25, 135, 84, 0.6)', // Green
                                borderDash: [5, 5],
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'T√©cnica (T)',
                                data: simData.T,
                                borderColor: 'rgba(13, 110, 253, 0.6)', // Blue
                                borderDash: [5, 5],
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Mentalidad (M)',
                                data: simData.M,
                                borderColor: 'rgba(255, 193, 7, 0.6)', // Yellow
                                borderDash: [5, 5],
                                borderWidth: 2,
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Edad del Jugador'
                                },
                                min: 0,
                                max: 50
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Nivel (0-100)'
                                },
                                min: 0,
                                max: 100
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Proyecci√≥n de Rendimiento'
                            }
                        }
                    }
                });

                // Fatigue Chart
                const fatigueCtx = document.getElementById('fatigueChart').getContext('2d');
                if (fatigueChart) fatigueChart.destroy();
                fatigueChart = new Chart(fatigueCtx, {
                    type: 'line',
                    data: {
                        labels: simData.age,
                        datasets: [{
                            label: 'Fatiga',
                            data: simData.fatigue,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.2)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => 'Fatiga: ' + ctx.parsed.y.toFixed(3)
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Edad (a√±os)' } },
                            y: { title: { display: true, text: 'Nivel (0-1)' }, min: 0, max: 1 }
                        }
                    }
                });

                // Build statistics table
                buildStatisticsTable(simData);

                // Calculate and render derivatives
                const derivatives = calculateDerivatives(simData);
                const derivCtx = document.getElementById('derivativesChart').getContext('2d');
                if (derivativesChart) derivativesChart.destroy();
                derivativesChart = new Chart(derivCtx, {
                    type: 'line',
                    data: {
                        labels: simData.age.slice(1),
                        datasets: [
                            { label: 'dR/dt (Rating)', data: derivatives.dR, borderColor: '#dc3545', borderWidth: 2.5, tension: 0.3, fill: false },
                            { label: 'dF/dt (F√≠sico)', data: derivatives.dF, borderColor: '#28a745', borderWidth: 1.5, tension: 0.3, fill: false },
                            { label: 'dT/dt (T√©cnica)', data: derivatives.dT, borderColor: '#007bff', borderWidth: 1.5, tension: 0.3, fill: false },
                            { label: 'dM/dt (Mental)', data: derivatives.dM, borderColor: '#ffc107', borderWidth: 1.5, tension: 0.3, fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Edad (a√±os)' } },
                            y: { title: { display: true, text: 'Tasa (puntos/a√±o)' } }
                        }
                    }
                });
            }
            
        } catch (error) {
            console.error('Error:', error);
            alert('Hubo un error al realizar la predicci√≥n.');
        }
    });
</script>

</body>
</html>
